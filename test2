@ExtendWith(MockitoExtension.class)
class ExternalJwtValidationFilterTest {
    @Mock
    RestTemplate restTemplate;
    @Mock
    FilterChain filterChain;
    ExternalJwtValidationFilter filter;
    @BeforeEach
    void setup() {
        filter = new ExternalJwtValidationFilter(restTemplate);
        ReflectionTestUtils.setField(filter, "jdbcAuthenticationUrl", "http://dummy/validate");
    }
    private MockHttpServletRequest requestWithHeaders(String jwt, String user, String secure) {
        MockHttpServletRequest req = new MockHttpServletRequest();
        if (jwt != null) req.addHeader(ApiMetricsConstants.JWT_TOKEN, jwt);
        if (user != null) req.addHeader(ApiMetricsConstants.USER_NAME, user);
        if (secure != null) req.addHeader(ApiMetricsConstants.SECURE, secure);
        return req;
    }
    @Test
    void testJwtValidationSuccess() throws Exception {
        MockHttpServletRequest request = requestWithHeaders("abc.jwt.token", null, null);
        MockHttpServletResponse response = new MockHttpServletResponse();
        AuthValidationResponse validationResp = new AuthValidationResponse();
        validationResp.setUserName("dilip");
        HttpEntity<String> requestEntity = new HttpEntity<>(new HttpHeaders());
        Mockito.when(restTemplate.exchange(
                Mockito.eq("http://dummy/validate"),
                Mockito.eq(HttpMethod.POST),
                Mockito.any(HttpEntity.class),
                Mockito.eq(AuthValidationResponse.class)
        )).thenReturn(new ResponseEntity<>(validationResp, HttpStatus.OK));
        filter.doFilter(request, response, filterChain);
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        assertNotNull(auth);
        assertEquals("dilip", auth.getName());

        Mockito.verify(filterChain, Mockito.times(1))
               .doFilter(request, response);
    }
@Test
    void testValidationApiException_Unauthorized() throws Exception {
        MockHttpServletRequest request = requestWithHeaders("abc.jwt.token", null, null);
        MockHttpServletResponse response = new MockHttpServletResponse();
        Mockito.when(restTemplate.exchange(
                Mockito.anyString(),
                Mockito.eq(HttpMethod.POST),
                Mockito.any(),
                Mockito.eq(AuthValidationResponse.class)
        )).thenThrow(new RuntimeException("Service down"));
        filter.doFilter(request, response, filterChain);
        assertEquals(HttpServletResponse.SC_UNAUTHORIZED, response.getStatus());
        assertTrue(response.getContentAsString().contains(ApiMetricsConstants.TOKEN_VALIDATION_FAILED));

        Mockito.verify(filterChain, Mockito.never()).doFilter(request, response);
    }
    
}
