private final WebClient webClient;

    public ExternalJwtValidationFilter(WebClient.Builder builder) {
        this.webClient = builder.build();
    }
@Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {

        String authHeader = request.getHeader("Authorization");

        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        String token = authHeader.substring(7);

        // 1) Call external Auth Service
        AuthValidationResponse validationResponse;
try {
            validationResponse = webClient.post()
                    .uri("http://auth-service/api/validate")
                    .header("Authorization", "Bearer " + token)
                    .retrieve()
                    .bodyToMono(AuthValidationResponse.class)
                    .block(); // safe here, because filter is blocking
        } catch (Exception e) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.getWriter().write("Token validation failed");
            return;
        }

if (validationResponse == null || !validationResponse.isValid()) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.getWriter().write("Invalid Token");
            return;
        }
UsernamePasswordAuthenticationToken auth =
                new UsernamePasswordAuthenticationToken(
                        validationResponse.getUsername(),
                        null,
                        validationResponse.getAuthorities()  // roles from auth service
                );

        SecurityContextHolder.getContext().setAuthentication(auth);

        // 4) Continue filter chain
        filterChain.doFilter(request, response);
    }
}
